{% extends 'web_base.html' %}
{% load i18n static %}
{% load custom_filters %}

{% block header %}
    {% include 'partials/header.html' %}
{% endblock %}


{% block greeting %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            
            <div class="mb-3">
                        <!-- {% if 'add' in model_permissions.inventoryitem %}
                            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importVehicleModal">
                                <i class="fas fa-file-import"></i> Import Stocks
                            </button>
                        {% endif %} -->
                    
                        <!-- Add Vehicle Button -->
                        {% if 'add' in model_permissions.inventoryitem %}
                            <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                                <i class="fas fa-plus-circle"></i> Add Invoice
                            </button>
                        {% endif %}
                       
                         
                </div>
                <div>
                    <h4 class="fs-16 fw-semibold mb-1 mb-md-2">Manage Warehouse Invoices</h4>
                    <p class="text-muted mb-0">Track and manage warehouse invoices, including transaction details, for efficient operations.</p>
                    <!-- <a href="/warehouse/invoice/create/" class="btn btn-primary mt-2">Create New Invoice</a> -->
                </div>
                
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">AMP</a></li>
                    {% for crumb in path|getcrumbs %}
                        {% if forloop.last %}
                            <li class="breadcrumb-item active">{{ crumb }}</li>
                        {% else %}
                            <li class="breadcrumb-item"><a href="/{{ crumb|lower }}">{{ crumb }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock greeting %}

{% block main_content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <!-- <h4 class="card-title">Inventory Details</h4> -->
                 <div></div>
                
                
                <!-- Import Vehicle Modal -->
                <div class="modal fade" id="importVehicleModal" tabindex="-1" aria-labelledby="importVehicleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Import Invoice</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form action="" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="csvFile" class="form-label">Upload CSV File</label>
                                        <input type="file" name="csv_file" class="form-control" id="csvFile" required>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-upload"></i> Upload
                                        </button>
                                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Barry Invoice</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addBarryInvoiceForm" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <input type="hidden" name="_method" value="PUT">
                                    <input type="hidden" name="invoice_id">
                
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Client</label>
                                            <select class="form-control" name="client" required>
                                                <option value="" disabled selected>Select a client</option>
                                                <option value="barry">Barry</option>
                                                <option value="cmc">CMC</option>
                                                <option value="amp">AMP</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" name="date">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vehicle Number</label>
                                            <input type="text" class="form-control" name="vehicle_number">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Waybill Number</label>
                                            <input type="text" class="form-control" name="waybill_number">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Contract Number</label>
                                            <input type="text" class="form-control" name="contract_number">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Stack Number</label>
                                            <input type="text" class="form-control" name="stack_number">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Block</label>
                                            <input type="text" class="form-control" name="block">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Bean Category</label>
                                            <input type="text" class="form-control" name="bean_category">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Origin Depot</label>
                                            <input type="text" class="form-control" name="origin_depot">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Destination</label>
                                            <input type="text" class="form-control" name="destination">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Bags</label>
                                            <input type="number" class="form-control" name="bags">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Barry Tonnage (MT)</label>
                                            <input type="number" step="0.01" class="form-control" name="barry_tonnage">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Net Weight (MT)</label>
                                            <input type="number" step="0.01" class="form-control" name="net_weight">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Days</label>
                                            <input type="number" class="form-control" name="days">
                                        </div>
                                        <div class="col-md-8 mb-3">
                                            <label class="form-label">Remarks</label>
                                            <input type="text" class="form-control" name="remarks">
                                        </div>
                                    </div>
                
                                    {% if 'change' in model_permissions.barryinvoice %}
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                    </div>
                                    {% endif %}
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script> -->

                <!-- <script>
                    $(document).ready(function() {
                        // Initialize Select2 on the category select field
                        $('.select2').select2({
                            placeholder: "Select a category", // Optional placeholder text
                            allowClear: true, // Allow the user to clear the selection
                        });
                    });
                </script> -->

                
                         
            </div>
           <div class="card-body">
                <div class="">
                    <table id="barryInvoiceTable" class="table table-striped table-bordered datatable">
                    <thead>
                        <tr>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Vehicle No.</th>
                        <th>Waybill No.</th>
                        <th>Contract No.</th>
                        <th>Stack No.</th>
                        <th>Block</th>
                        <th>Depot</th>
                        <th>Destination</th>
                        <th>Bags</th>
                        <th>Tonnage (MT)</th>
                        <th>Net Weight (MT)</th>
                        <th>Days</th>
                        <th>Remarks</th>
                        {% if 'view' in model_permissions.barryinvoice %}
                        <th>Action</th>
                        {% endif %}
                        </tr>
                    </thead>
                    </table>
                </div>

                <!-- Edit BarryInvoice Modal -->
                <div class="modal fade" id="editInvoiceModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title">Edit Barry Invoice</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                        <form id="editBarryInvoiceForm" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="_method" value="PUT">
                            <input type="hidden" name="invoice_id">

                            <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" name="date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Vehicle Number</label>
                                <input type="text" class="form-control" name="vehicle_number">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Waybill Number</label>
                                <input type="text" class="form-control" name="waybill_number">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contract Number</label>
                                <input type="text" class="form-control" name="contract_number">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stack Number</label>
                                <input type="text" class="form-control" name="stack_number">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Block</label>
                                <input type="text" class="form-control" name="block">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Origin Depot</label>
                                <input type="text" class="form-control" name="origin_depot">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Destination</label>
                                <input type="text" class="form-control" name="destination">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Bags</label>
                                <input type="number" class="form-control" name="bags">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Barry Tonnage (MT)</label>
                                <input type="number" step="0.01" class="form-control" name="barry_tonnage">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Net Weight (MT)</label>
                                <input type="number" step="0.01" class="form-control" name="net_weight">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Days</label>
                                <input type="number" class="form-control" name="days">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Remarks</label>
                                <input type="text" class="form-control" name="remarks">
                            </div>
                            </div>

                            {% if 'change' in model_permissions.barryinvoice %}
                            <div class="text-center">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                            {% endif %}
                        </form>
                        </div>
                    </div>
                    </div>
                </div>

        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> Â© AMP.
            </div>
            <!-- <div class="col-sm-6">
                <div class="text-sm-end d-none d-sm-block">
                    Crafted with <i class="mdi mdi-heart text-danger"></i> by <a href="#" target="_blank" class="text-muted">AMPstudio</a>
                </div>
            </div> -->
        </div>
    </div>
</footer>

<!-- TomSelect CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">

<!-- TomSelect JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>


<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>

<!-- Export & Import Scripts -->
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>



<script>
    new TomSelect("#category_select", {
      create: false,
      sortField: {
        field: "text",
        direction: "asc"
      },
      placeholder: "Search or select a category",
      allowEmptyOption: true
    });
  </script>
  




<!-- Modal for showing full description -->
<!-- Modal Structure -->
<div class="modal fade" id="descriptionModal" tabindex="-1" aria-labelledby="descriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="descriptionModalLabel">Full Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="modal-description-text"></p> <!-- Full description will go here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<script>
    $(document).ready(function(){
    let table = $('#barryInvoiceTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        responsive: true,
        autoWidth: false,
        processing: true,
        serverSide: false,  // Keep false unless you're paginating from server
        pageLength: 15,
        lengthMenu: [ [5, 10, 25, 50, -1], [5, 10, 25, 50, "All"] ],
        ajax: {
            url: "/warehouse/list-barry-invoice/",  // Your API endpoint
            type: "GET"
        },
        columns: [
            { data: "client", render: data => data?.toUpperCase() ?? "" },
            { data: "date" },
            { data: "vehicle_number", render: data => data?.toUpperCase() ?? "" },
            { data: "waybill_number", render: data => data?.toUpperCase() ?? "" },
            { data: "contract_number", render: data => data?.toUpperCase() ?? "" },
            { data: "stack_number", render: data => data?.toUpperCase() ?? "" },
            { data: "block", render: data => data?.toUpperCase() ?? "" },
            { data: "origin_depot", render: data => data?.toUpperCase() ?? "" },
            { data: "destination", render: data => data?.toUpperCase() ?? "" },
            { data: "bags" },
            { data: "barry_tonnage" },
            { data: "net_weight" },
            { data: "days" },
            {
                data: "remarks",
                render: function(data) {
                    const upperRemarks = data ? data.toUpperCase() : "";
                    if (data && data.length > 20) {
                        return `${upperRemarks.substring(0, 20)}... <a href="#" class="show-more" data-description="${data}">more</a>`;
                    }
                    return upperRemarks;
                }
            },
            {
                data: "id",
                render: function(data, type, row) {
                    return `
                        <div style="display: flex; gap: 5px;">
                            {% if 'view' in model_permissions.barryinvoice %}
                            <button class="btn btn-sm btn-primary edit-barry-invoice" data-id="${data}">Edit</button>
                            {% endif %}
                            {% if 'delete' in model_permissions.barryinvoice %}
                            <button class="btn btn-sm btn-danger delete-invoice" data-id="${data}">Delete</button>
                            {% endif %}
                        </div>
                    `;
                }
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'csv',
                text: 'Export CSV',
                className: 'btn btn-sm btn-info'
            },
            {
                extend: 'excel',
                text: 'Export Excel',
                className: 'btn btn-sm btn-success'
            },
            {
                extend: 'pdf',
                text: 'Export PDF',
                className: 'btn btn-sm btn-danger'
            },
            {
                extend: 'print',
                text: 'Print',
                className: 'btn btn-sm btn-primary'
            }
        ]
    });



    $(document).on('click', '.show-more', function(e) {
        e.preventDefault();
        var fullDescription = $(this).data('description');  // Get the full description
        $('#modal-description-text').text(fullDescription);  // Set the description in the modal
        $('#descriptionModal').modal('show');  // Show the modal
    });


    $("#addBarryInvoiceForm").submit(function (e) {
        e.preventDefault();

        let formData = new FormData(this); // Use FormData for file uploads
        console.log(formData.entries());  // Log FormData entries for debugging
        
        // Loop through form data to log the file name
        for (let [key, value] of formData.entries()) {
            if (value instanceof File) {
                console.log(key + ' (File): ' + value.name);  // Log the file name
            } else {
                console.log(key + ': ' + value);  // Log other form data
            }
        }

        $.ajax({
        url: "/warehouse/create-barry-invoice/",
        type: "POST",
        data: formData,
        processData: false,  // Don't let jQuery process the data
        contentType: false,  // Let the browser set the content type (including boundary for file uploads)
        headers: {
            "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val()
        },
        beforeSend: function () {
            $("button[type=submit]").prop("disabled", true);  // Disable button to prevent multiple clicks
        },
        success: function (response) {
            if (response.status === "success") {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: response.message,
                    confirmButtonText: 'OK'
                }).then(() => {
                    $("#addInvoiceModal").modal("hide");
                    location.reload();  // Refresh the page or reload the table dynamically
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: response.message,
                    confirmButtonText: 'OK'
                });
            }
            },
            error: function (xhr, status, error) {
                console.error('Error status: ', status);
                console.error('Error response: ', xhr.responseText);
                console.error('Error details: ', error);

                Swal.fire({
                    icon: 'error',
                    title: 'Request Failed',
                    text: 'An error occurred while processing your request. Please try again.',
                    confirmButtonText: 'OK'
                });
            },
            complete: function () {
                $("button[type=submit]").prop("disabled", false);  // Re-enable button
            }
        });

    });

    // Event listener for Edit button
//     $(document).on("click", ".edit-btn", function () {
//     let itemId = $(this).data("id"); // Get the inventory item ID

//     console.log("Fetching item ID:", itemId); // Debugging log

//     $.ajax({
//         url: `/inventory/inventory-item/${itemId}/`, // Update this URL as per your API endpoint
//         type: "GET",
//         success: function (response) {
//             if (response.success) {
//                 // Populate form fields
//                 $("#editInventoryForm input[name='name']").val(response.name);
//                 $("#editInventoryForm input[name='category']").val(response.category);
//                 $("#editInventoryForm textarea[name='description']").val(response.description);
//                 $("#editInventoryForm input[name='quantity']").val(response.quantity);
//                 $("#editInventoryForm input[name='reorder_level']").val(response.reorder_level);

//                 // Store the item ID in the form (or modal) for later use
//                 $("#editInventoryForm").data("id", itemId); // Store itemId on the form

//                 // Show the modal
//                 $("#editModal").modal("show");
//             } else {
//                 alert("Failed to fetch inventory details!");
//             }
//         },
//         // Error handler for AJAX call failure
//         // Alert the user with the error response from the server
//         error: function (xhr) {
//             alert(`Error fetching details: ${xhr.responseText}`);
//         },
//     });
// });



//     /// Get the CSRF token from the cookie (make sure you have this helper function)
// function getCookie(name) {
//     let cookieValue = null;
//     if (document.cookie && document.cookie !== '') {
//         const cookies = document.cookie.split(';');
//         for (let i = 0; i < cookies.length; i++) {
//             const cookie = cookies[i].trim();
//             if (cookie.substring(0, name.length + 1) === (name + '=')) {
//                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
//                 break;
//             }
//         }
//     }
//     return cookieValue;
// }
// $(document).on("submit", "#editInventoryForm", function (e) {
//     e.preventDefault(); // Prevent default form submission

//     // Retrieve the itemId from the form's data attribute
//     let itemId = $(this).data("id"); // Get the item ID that was stored earlier
//     let formData = new FormData(this); // Serialize form data

//     $.ajax({
//         url: `/inventory/update/${itemId}/`, // Make sure this URL matches your view
//         type: "POST",
//         data: formData,
//         processData: false,
//         contentType: false,
//         headers: {
//             "X-CSRFToken": getCookie("csrftoken") // CSRF token header
//         },
//         success: function (response) {
//             if (response.message) {
//                 Swal.fire("Saved!", response.message, "success");
//                 $("#editModal").modal("hide"); // Close modal after saving
//                 table.ajax.reload(); // Reload the table if needed
//             } else {
//                 Swal.fire("Warning", response.error || "Update failed!", "warning");
//             }
//         },
//         error: function (xhr) {
//             Swal.fire("Error", "An error occurred during the update.", "error");
//         }
//     });
// });

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Edit Invoice - Load Data into Modal
$(document).on("click", ".edit-barry-invoice", function() {
    const invoiceId = $(this).data('id');
    const $modal = $("#editInvoiceModal");
    const $form = $modal.find("#editBarryInvoiceForm");
    
    // Show loading state
    $form.find('button[type="submit"]').prop('disabled', true).html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Loading...
    `);
    
    $.ajax({
        url: `/warehouse/invoices/barry/${invoiceId}/`,
        type: "GET",
        success: function(response) {
            if (response.success) {
                // Populate form fields
                const data = response.data;
                $form.find('input[name="invoice_id"]').val(invoiceId);
                $form.find('input[name="date"]').val(data.date);
                $form.find('input[name="vehicle_number"]').val(data.vehicle_number);
                $form.find('input[name="waybill_number"]').val(data.waybill_number);
                $form.find('input[name="contract_number"]').val(data.contract_number);
                $form.find('input[name="stack_number"]').val(data.stack_number);
                $form.find('input[name="block"]').val(data.block);
                $form.find('input[name="origin_depot"]').val(data.origin_depot);
                $form.find('input[name="destination"]').val(data.destination);
                $form.find('input[name="bags"]').val(data.bags);
                $form.find('input[name="barry_tonnage"]').val(data.barry_tonnage);
                $form.find('input[name="net_weight"]').val(data.net_weight);
                $form.find('input[name="days"]').val(data.days);
                $form.find('input[name="remarks"]').val(data.remarks);
                
                // Show modal
                $modal.modal('show');
            } else {
                Swal.fire('Error', response.message || 'Failed to load invoice', 'error');
            }
        },
        error: function(xhr) {
            Swal.fire('Error', xhr.responseJSON?.message || 'Failed to load invoice', 'error');
        },
        complete: function() {
            $form.find('button[type="submit"]').prop('disabled', false).text('Save Changes');
        }
    });
});

// Update Invoice - Submit Form
$(document).on("submit", "#editBarryInvoiceForm", function(e) {
    e.preventDefault();
    
    const $form = $(this);
    const invoiceId = $form.find('input[name="invoice_id"]').val();
    const $submitBtn = $form.find('button[type="submit"]');
    const originalBtnText = $submitBtn.html();
    
    // Set loading state
    $submitBtn.prop('disabled', true).html(`
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Saving...
    `);
    
    Swal.fire({
        title: 'Confirm Update',
        text: 'Are you sure you want to update this invoice?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/warehouse/invoices/barry/${invoiceId}/update/`,
                type: "POST",
                data: $form.serialize(),
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Success', response.message || 'Invoice updated successfully', 'success');
                        $("#editInvoiceModal").modal('hide');
                        // Reload DataTable if you're using one
                        if (typeof table !== 'undefined') {
                            table.ajax.reload(null, false);
                        }
                    } else {
                        Swal.fire('Error', response.message || 'Update failed', 'error');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'An error occurred while updating the invoice';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMsg = response.message || errorMsg;
                    } catch (e) {
                        errorMsg = xhr.responseText || errorMsg;
                    }
                    Swal.fire('Error', errorMsg, 'error');
                },
                complete: function() {
                    $submitBtn.prop('disabled', false).html(originalBtnText);
                }
            });
        } else {
            $submitBtn.prop('disabled', false).html(originalBtnText);
        }
    });
});

// Delete Invoice
// Solution 1: Using JavaScript function (add this above your event handler)
// Updated getCSRFToken function
function getCSRFToken() {
    const csrfCookie = document.cookie.match(/csrftoken=([^;]+)/);
    return csrfCookie ? csrfCookie[1] : '';
}

// Delete invoice event handler
$(document).on("click", ".delete-invoice", function() {
    const invoiceId = $(this).data('id');
    
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/warehouse/barry-invoice/${invoiceId}/delete/`,
                method: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                beforeSend: function() {
                    $(`.delete-invoice[data-id="${invoiceId}"]`).html(`
                        <span class="spinner-border spinner-border-sm" role="status"></span> Deleting...
                    `).prop('disabled', true);
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire('Deleted!', response.message, 'success');
                        // Reload DataTable or refresh the list
                        if (typeof table !== 'undefined') {
                            table.ajax.reload(null, false);
                        } else {
                            location.reload();  // Fallback reload
                        }
                    } else {
                        Swal.fire('Error', response.message || 'Failed to delete', 'error');
                    }
                },
                error: function(xhr) {
                    Swal.fire('Error', xhr.responseJSON?.message || 'Failed to delete', 'error');
                },
                complete: function() {
                    $(`.delete-invoice[data-id="${invoiceId}"]`)
                        .html('<i class="fas fa-trash"></i> Delete')
                        .prop('disabled', false);
                }
            });
        }
    });
});
});



</script>

{% endblock %}