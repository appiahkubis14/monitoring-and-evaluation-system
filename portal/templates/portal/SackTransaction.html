{% extends 'web_base.html' %}
{% load i18n static %}
{% load custom_filters %}

{% block header %}
    {% include 'partials/header.html' %}
{% endblock %}

{% block greeting %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <div>
                <h4 class="fs-16 fw-semibold mb-1 mb-md-2">Sack Transaction Overview</h4>
                <p class="text-muted mb-0">Manage sack transactions across warehouses</p>
            </div>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">AMP</a></li>
                    {% for crumb in path|getcrumbs %}
                        {% if forloop.last %}
                            <li class="breadcrumb-item active">{{ crumb }}</li>
                        {% else %}
                            <li class="breadcrumb-item"><a href="/{{ crumb|lower }}">{{ crumb }}</a></li>
                        {% endif %}
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock greeting %}

{% block main_content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title">Sack Transactions</h4>
                
                <!-- Filter section -->
                <div class="d-flex gap-2">
                    {% if warehouses %}
                    <select id="warehouseFilter" class="form-select form-select-sm" style="width: 200px;">
                        <option value="">All Warehouses</option>
                        {% for warehouse in warehouses %}
                        <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                    
                    <button class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addSackTransactionModal">
                        <i class="fas fa-plus-circle"></i> Add Sack Transaction
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="sackTransactionTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Warehouse</th>
                                <th>Date</th>
                                <th>Details</th>
                                <th>Ghana</th>
                                <th>IVC</th>
                                <th>Nigeria</th>
                                <th>Cameroon</th>
                                <th>Rebagging</th>
                                <th>Country</th>
                                <th>Issued</th>
                                <th>Torn</th>
                                <th>Retrieved</th>
                                <th>Actual Balance</th>
                                <th>Available</th>
                                <th>Total</th>
                                <th>Added By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated by DataTables -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Sack Transaction Modal -->
<div class="modal fade" id="addSackTransactionModal" tabindex="-1" aria-labelledby="addSackTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSackTransactionModalLabel">Add Sack Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSackTransactionForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Warehouse <span class="text-danger">*</span></label>
                            <select name="warehouse" id="warehouse" class="form-select" required>
                                <option value="">Select Warehouse</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" name="date" id="date" class="form-control" required value="{{ today|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Details</label>
                            <input type="text" name="details" id="details" class="form-control" placeholder="Transaction details">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ghana Sacks</label>
                            <input type="number" name="ghana_sacks" id="ghana_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">IVC Sacks</label>
                            <input type="number" name="ivc_sacks" id="ivc_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nigeria Sacks</label>
                            <input type="number" name="nigeria_sacks" id="nigeria_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cameroon Sacks</label>
                            <input type="number" name="cameroon_sacks" id="cameroon_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rebagging</label>
                            <input type="number" name="rebagging" id="rebagging" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" name="country" id="country" class="form-control" placeholder="Country code">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Issued</label>
                            <input type="number" name="issued" id="issued" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Torn</label>
                            <input type="number" name="torn" id="torn" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Retrieved</label>
                            <input type="number" name="retrieved" id="retrieved" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Actual Balance</label>
                            <input type="number" name="actual_balance" id="actual_balance" class="form-control" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Available Sacks</label>
                            <input type="number" name="available_sacks" id="available_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea name="remarks" id="remarks" class="form-control" rows="2" placeholder="Additional remarks"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveSackTransactionBtn">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Sack Transaction Modal -->
<div class="modal fade" id="editSackTransactionModal" tabindex="-1" aria-labelledby="editSackTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSackTransactionModalLabel">Edit Sack Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editSackTransactionForm">
                    {% csrf_token %}
                    <input type="hidden" name="transaction_id" id="edit_transaction_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Warehouse <span class="text-danger">*</span></label>
                            <select name="warehouse" id="edit_warehouse" class="form-select" required>
                                <option value="">Select Warehouse</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Date <span class="text-danger">*</span></label>
                            <input type="date" name="date" id="edit_date" class="form-control" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Details</label>
                            <input type="text" name="details" id="edit_details" class="form-control" placeholder="Transaction details">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ghana Sacks</label>
                            <input type="number" name="ghana_sacks" id="edit_ghana_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">IVC Sacks</label>
                            <input type="number" name="ivc_sacks" id="edit_ivc_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nigeria Sacks</label>
                            <input type="number" name="nigeria_sacks" id="edit_nigeria_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cameroon Sacks</label>
                            <input type="number" name="cameroon_sacks" id="edit_cameroon_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rebagging</label>
                            <input type="number" name="rebagging" id="edit_rebagging" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Country</label>
                            <input type="text" name="country" id="edit_country" class="form-control" placeholder="Country code">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Issued</label>
                            <input type="number" name="issued" id="edit_issued" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Torn</label>
                            <input type="number" name="torn" id="edit_torn" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Retrieved</label>
                            <input type="number" name="retrieved" id="edit_retrieved" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Actual Balance</label>
                            <input type="number" name="actual_balance" id="edit_actual_balance" class="form-control" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Available Sacks</label>
                            <input type="number" name="available_sacks" id="edit_available_sacks" class="form-control" value="0" min="0">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea name="remarks" id="edit_remarks" class="form-control" rows="2" placeholder="Additional remarks"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="updateSackTransactionBtn">
                    <i class="fas fa-save"></i> Update Transaction
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewTransactionModal" tabindex="-1" aria-labelledby="viewTransactionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTransactionModalLabel">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <strong>Warehouse:</strong> <span id="view_warehouse"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Date:</strong> <span id="view_date"></span>
                    </div>
                    <div class="col-md-12 mb-2">
                        <strong>Details:</strong> <span id="view_details"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Ghana Sacks:</strong> <span id="view_ghana_sacks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>IVC Sacks:</strong> <span id="view_ivc_sacks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Nigeria Sacks:</strong> <span id="view_nigeria_sacks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Cameroon Sacks:</strong> <span id="view_cameroon_sacks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Rebagging:</strong> <span id="view_rebagging"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Country:</strong> <span id="view_country"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Issued:</strong> <span id="view_issued"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Torn:</strong> <span id="view_torn"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Retrieved:</strong> <span id="view_retrieved"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Actual Balance:</strong> <span id="view_actual_balance"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Available Sacks:</strong> <span id="view_available_sacks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Total:</strong> <span id="view_total"></span>
                    </div>
                    <div class="col-md-12 mb-2">
                        <strong>Remarks:</strong> <span id="view_remarks"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Added By:</strong> <span id="view_added_by"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Added Date:</strong> <span id="view_added_date"></span>
                    </div>
                    <div class="col-md-6 mb-2">
                        <strong>Last Updated:</strong> <span id="view_last_updated"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> © AMP.
            </div>
        </div>
    </div>
</footer>

<!-- Required CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css">

<!-- Required JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.colVis.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function () {
    // Initialize Select2
    $('#warehouse').select2({
        dropdownParent: $('#addSackTransactionModal'),
        placeholder: "Select a warehouse",
        allowClear: true
    });

    $('#edit_warehouse').select2({
        dropdownParent: $(' #editSackTransactionModal'),
        placeholder: "Select a warehouse",
        allowClear: true
    });
    
    
   // Initialize DataTable
let table = $('#sackTransactionTable').DataTable({
    processing: true,
    // serverSide: true,
    responsive: true,
    ajax: {
        url: "/warehouse/api/sack-transactions/",
        data: function (d) {
            d.warehouse = $('#warehouseFilter').val();
        },
        error: function(xhr, error, thrown) {
            console.error("DataTables error:", error, thrown);
            console.error("DataTables error:", xhr.responseJSON);
            Swal.fire("Error", "Failed to load data. Please try again or contact support if the problem persists.", "error");
            // alert("Failed to load data. Please try again or contact support if the problem persists.");
        }
    },
    columns: [
        { data: 'id' },
        { data: 'warehouse_name' },
        { data: 'date' },
        { 
            data: 'details', 
            render: function(data, type, row) {
                return data && data.length > 50 ? data.substr(0, 50) + '...' : data;
            } 
        },
        { data: 'ghana_sacks', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'ivc_sacks', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'nigeria_sacks', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'cameroon_sacks', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'rebagging', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'country', className: 'text-center' },
        { data: 'issued', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'torn', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'retrieved', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'actual_balance', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'available_sacks', className: 'text-end', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'total', className: 'text-end fw-bold', render: $.fn.dataTable.render.number(',', '.', 0, '') },
        { data: 'added_by' },
        {
            data: null,
            orderable: false,
            className: 'text-center',
            render: function (data, type, row) {
                return `
                    <div class="btn-group btn-group-sm" style="display: flex; gap: 5px;">
                        <button class="btn btn-info view-transaction" data-id="${row.id}" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary edit-transaction" data-id="${row.id}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger delete-transaction" data-id="${row.id}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }
        }
    ],
    dom: 'Bfrtip',
    buttons: [
        {
            extend: 'colvis',
            text: 'Columns',
            className: 'btn btn-sm btn-outline-secondary'
        },
        {
            extend: 'csv',
            text: 'CSV',
            className: 'btn btn-sm btn-outline-primary',
            exportOptions: {
                columns: ':visible'
            }
        },
        {
            extend: 'excel',
            text: 'Excel',
            className: 'btn btn-sm btn-outline-success',
            exportOptions: {
                columns: ':visible'
            }
        },
        {
            extend: 'pdf',
            text: 'PDF',
            className: 'btn btn-sm btn-outline-danger',
            exportOptions: {
                columns: ':visible'
            }
        },
        {
            extend: 'print',
            text: 'Print',
            className: 'btn btn-sm btn-outline-dark',
            exportOptions: {
                columns: ':visible'
            }
        }
    ],
    order: [[2, 'desc']],
    pageLength: 25,
    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
    language: {
        emptyTable: "No sack transactions found",
        zeroRecords: "No matching transactions found"
    }
});

// Add event handlers for the action buttons


// Add refresh functionality if you have a refresh button
$('#refreshTable').on('click', function() {
    table.ajax.reload();
});

// // Add warehouse filter change handler if you have a filter
// $('#warehouseFilter').on('change', function() {
//     table.ajax.reload();
// });
    
    // Apply warehouse filter
    $('#warehouseFilter').on('change', function() {
        table.ajax.reload();
    });
    
    // Save new transaction
    $('#saveSackTransactionBtn').on('click', function() {
        const form = $('#addSackTransactionForm');
        const formData = new FormData(form[0]);
        
        // Basic validation
        if (!formData.get('warehouse') || !formData.get('date')) {
            Swal.fire('Error', 'Warehouse and Date are required fields', 'error');
            return;
        }
        
        $.ajax({
            url: "{% url 'create_sack_transaction' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val() },
            beforeSend: function() {
                $('#saveSackTransactionBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
            },
            success: function(response) {
                if (response.status === 'success') {
                    Swal.fire('Success', response.message, 'success');
                    $('#addSackTransactionModal').modal('hide');
                    form[0].reset();
                    table.ajax.reload();
                } else {
                    Swal.fire('Error', response.message, 'error');
                }
            },
            error: function(xhr) {
                let errorMsg = 'An error occurred while saving the transaction';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) errorMsg = response.message;
                } catch (e) {
                    // Use default error message
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#saveSackTransactionBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Save Transaction');
            }
        });
    });
    
    // View transaction details
    $('#sackTransactionTable').on('click', '.view-transaction', function() {
        const transactionId = $(this).data('id');
        console.log("Transaction ID:", transactionId);
        
        $.ajax({
            url: `/warehouse/get-sack-transaction/${transactionId}/`,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    $('#view_warehouse').text(response.warehouse_name);
                    $('#view_date').text(response.date);
                    $('#view_details').text(response.details || 'N/A');
                    $('#view_ghana_sacks').text(response.ghana_sacks);
                    $('#view_ivc_sacks').text(response.ivc_sacks);
                    $('#view_nigeria_sacks').text(response.nigeria_sacks);
                    $('#view_cameroon_sacks').text(response.cameroon_sacks);
                    $('#view_rebagging').text(response.rebagging);
                    $('#view_country').text(response.country || 'N/A');
                    $('#view_issued').text(response.issued);
                    $('#view_torn').text(response.torn);
                    $('#view_retrieved').text(response.retrieved);
                    $('#view_actual_balance').text(response.actual_balance);
                    $('#view_available_sacks').text(response.available_sacks);
                    $('#view_total').text(response.total);
                    $('#view_remarks').text(response.remarks || 'N/A');
                    $('#view_added_by').text(response.added_by);
                    $('#view_added_date').text(response.added_date);
                    $('#view_last_updated').text(response.last_updated || 'N/A');
                    
                    $('#viewTransactionModal').modal('show');
                } else {
                    Swal.fire('Error', response.error || 'Failed to fetch transaction details', 'error');
                }
            },
            error: function(xhr) {
                Swal.fire('Error', 'Failed to fetch transaction details', 'error');
            }
        });
    });
    
    // Edit transaction - load data
    $('#sackTransactionTable').on('click', '.edit-transaction', function() {
        const transactionId = $(this).data('id');
        
        $.ajax({
            url: `/warehouse/get-sack-transaction/${transactionId}/`,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    $('#edit_transaction_id').val(response.id);
                    $('#edit_warehouse').val(response.warehouse_id).trigger('change');
                    $('#edit_date').val(response.date);
                    $('#edit_details').val(response.details);
                    $('#edit_ghana_sacks').val(response.ghana_sacks);
                    $('#edit_ivc_sacks').val(response.ivc_sacks);
                    $('#edit_nigeria_sacks').val(response.nigeria_sacks);
                    $('#edit_cameroon_sacks').val(response.cameroon_sacks);
                    $('#edit_rebagging').val(response.rebagging);
                    $('#edit_country').val(response.country);
                    $('#edit_issued').val(response.issued);
                    $('#edit_torn').val(response.torn);
                    $('#edit_retrieved').val(response.retrieved);
                    $('#edit_actual_balance').val(response.actual_balance);
                    $('#edit_available_sacks').val(response.available_sacks);
                    $('#edit_remarks').val(response.remarks);
                    
                    $('#editSackTransactionModal').modal('show');
                } else {
                    Swal.fire('Error', response.error || 'Failed to fetch transaction details', 'error');
                }
            },
            error: function(xhr) {
                Swal.fire('Error', 'Failed to fetch transaction details', 'error');
            }
        });
    });
    
    // Update transaction
    $('#updateSackTransactionBtn').on('click', function() {
        const form = $('#editSackTransactionForm');
        const formData = new FormData(form[0]);
        const transactionId = $('#edit_transaction_id').val();

        console.log(formData)
        
        // Basic validation
        if (!formData.get('warehouse') || !formData.get('date')) {
            Swal.fire('Error', 'Warehouse and Date are required fields', 'error');
            return;
        }
        
        $.ajax({
            url: `/warehouse/sack-transaction/${transactionId}/update/`,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val() },
            beforeSend: function() {
                $('#updateSackTransactionBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');
            },
            success: function(response) {
                if (response.message) {
                    Swal.fire('Success', response.message, 'success');
                    $('#editSackTransactionModal').modal('hide');
                    table.ajax.reload();
                } else {
                    Swal.fire('Error', response.error || 'Failed to update transaction', 'error');
                }
            },
            error: function(xhr) {
                let errorMsg = 'An error occurred while updating the transaction';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.error) errorMsg = response.error;
                } catch (e) {
                    // Use default error message
                }
                Swal.fire('Error', errorMsg, 'error');
            },
            complete: function() {
                $('#updateSackTransactionBtn').prop('disabled', false).html('<i class="fas fa-save"></i> Update Transaction');
            }
        });
    });
    
    // Delete transaction
    $('#sackTransactionTable').on('click', '.delete-transaction', function() {
        const transactionId = $(this).data('id');
        
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: `/warehouse/sack-transaction/${transactionId}/delete/`,
                    type: "DELETE",
                    headers: { "X-CSRFToken": $('input[name="csrfmiddlewaretoken"]').val() },
                    success: function(response) {
                        Swal.fire('Deleted!', response.message || 'Transaction deleted successfully.', 'success');
                        table.ajax.reload();
                    },
                    error: function(xhr) {
                        let errorMsg = 'Failed to delete transaction';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) errorMsg = response.error;
                        } catch (e) {
                            // Use default error message
                        }
                        Swal.fire('Error!', errorMsg, 'error');
                    }
                });
            }
        });
    });
    
    // Reset form when modal is closed
    $('#addSackTransactionModal, #editSackTransactionModal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
    });
});
</script>
{% endblock %}
