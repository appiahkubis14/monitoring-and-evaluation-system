{% extends 'web_base.html' %}
{% load i18n static %}
{% load filters %}
{% load custom_filters %}
{% load humanize %}
{# to use naturaltime filter #} 


{% block header %}
    {% include 'partials/header.html' %}
{% endblock %}



{% block main_content %}
<!-- Warehouse Selector -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">WAREHOUSE</h5>
                     <p class="text-muted mb-0">REAL-TIME OVERVIEW OF {{ selected_warehouse.name }} WAREHOUSE</p>
                    <form method="get" class="d-flex gap-2">
                        <select name="warehouse" class="form-select form-select-sm" style="width: 250px;" onchange="this.form.submit()">
                            {% for warehouse in warehouses %}
                            <option value="{{ warehouse.id }}" {% if selected_warehouse.id == warehouse.id %}selected{% endif %}>
                                {{ warehouse.name }} - {{ warehouse.location }}
                            </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row">
    <!-- Total Sacks Card -->
    <div class="col-xl-3 col-md-6">
        <div class="card bg-primary bg-opacity-10 border-0">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="fs-14 mb-3">Total Sacks</h5>
                        <h2 class="mb-0"><span class="counter-value" data-target="{{ total_sacks }}">0</span></h2>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-sack text-primary fs-24"></i>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <small class="text-muted">Ghana: {{ sack_totals.total_ghana }}</small>
                    <small class="text-muted">IVC: {{ sack_totals.total_ivc }}</small>
                </div>
                <div class="d-flex justify-content-between">
                    <small class="text-muted">Nigeria: {{ sack_totals.total_nigeria }}</small>
                    <small class="text-muted">Cameroon: {{ sack_totals.total_cameroon }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Beans Stock Card -->
    <div class="col-xl-3 col-md-6">
        <div class="card bg-success bg-opacity-10 border-0">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="fs-14 mb-3">Beans Stock</h5>
                        <h2 class="mb-0"><span class="counter-value" data-target="{{ beans_stock.total_bags }}">0</span></h2>
                        <p class="text-muted mb-0">{{ beans_stock.total_tonnage|floatformat:2 }} MT</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-weight-scale text-success fs-24"></i>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 5px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Card -->
    <div class="col-xl-3 col-md-6">
        <div class="card bg-info bg-opacity-10 border-0">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="fs-14 mb-3">Bean Categories</h5>
                        <h2 class="mb-0"><span class="counter-value" data-target="{{ category_stock|length }}">0</span></h2>
                        <p class="text-muted mb-0">Active categories</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-layer-group text-info fs-24"></i>
                    </div>
                </div>
                <div class="mt-3">
                    {% for category in category_stock|slice:":2" %}
                    <span class="badge bg-info me-1">{{ category.bean_category|default:"Unknown" }}: {{ category.total_bags }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Blocks Card -->
    <div class="col-xl-3 col-md-6">
        <div class="card bg-warning bg-opacity-10 border-0">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="fs-14 mb-3">Warehouse Blocks</h5>
                        <h2 class="mb-0"><span class="counter-value" data-target="{{ block_stock|length }}">0</span></h2>
                        <p class="text-muted mb-0">Active blocks</p>
                    </div>
                    <div class="flex-shrink-0">
                        <i class="fas fa-building text-warning fs-24"></i>
                    </div>
                </div>
                <div class="mt-3">
                    {% for block in block_stock|slice:":3" %}
                    <span class="badge bg-warning me-1">{{ block.block }}: {{ block.total_bags }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Visualizations Row -->
<div class="row mt-4">
    <!-- Sacks Distribution Chart -->
    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Sacks Distribution by Country</h5>
            </div>
            <div class="card-body">
                <div id="sacksChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Bean Categories Chart -->
    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Stock by Bean Category</h5>
            </div>
            <div class="card-body">
                <div id="categoriesChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Warehouse Blocks Chart -->
    <div class="col-xl-4 col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Stock by Warehouse Block</h5>
            </div>
            <div class="card-body">
                <div id="blocksChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Information Row -->
<div class="row mt-4">
    <!-- Contract Numbers Table -->
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Top Contracts by Stock</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table ">
                        <thead>
                            <tr>
                                <th>Contract Number</th>
                                <th>Bags</th>
                                <th>Tonnage (MT)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contract in contract_stock %}
                            <tr>
                                <td>{{ contract.contract_number }}</td>
                                <td>{{ contract.total_bags|default:0 }}</td>
                                <td>{{ contract.total_tonnage|default:0|floatformat:2 }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No contract data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Recent Activities</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table ">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Contract</th>
                                <th>Bags</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activities %}
                            <tr>
                                <td>{{ activity.date }}</td>
                                <td>{{ activity.contract_number }}</td>
                                <td>{{ activity.bags|default:0 }}</td>
                                <td><span class="badge bg-info">{{ activity.bean_category|default:"Unknown" }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No recent activities</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Tables Row -->
<div class="row mt-4">
    <!-- Bean Categories Details -->
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Stock by Bean Category</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Bags</th>
                                <th>Tonnage (MT)</th>
                                <th>Avg/Bag (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in category_stock %}
                            <tr>
                                <td>{{ category.bean_category|default:"Unknown" }}</td>
                                <td>{{ category.total_bags }}</td>
                                <td>{{ category.total_tonnage|floatformat:2 }}</td>
                                <td>
                                    {% if category.total_bags > 0 %}
                                        {{ category.total_tonnage|mul:1000|div:category.total_bags|floatformat:2 }}
                                    {% else %}
                                        0.00
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No category data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Warehouse Blocks Details -->
    <div class="col-xl-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Stock by Warehouse Block</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Block</th>
                                <th>Bags</th>
                                <th>Tonnage (MT)</th>
                                <th>Avg/Bag (kg)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for block in block_stock %}
                            <tr>
                                <td>{{ block.block }}</td>
                                <td>{{ block.total_bags }}</td>
                                <td>{{ block.total_tonnage|floatformat:2 }}</td>
                                <td>
                                    {% if block.total_bags > 0 %}
                                        {{ block.total_tonnage|mul:1000|div:block.total_bags|floatformat:2 }}
                                    {% else %}
                                        0.00
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No block data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> © AMP.
            </div>
        </div>
    </div>
</footer>

<!-- ECharts Library -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<script>
// Store chart instances and types
const chartInstances = {};
const chartTypes = {
    sacksChart: 'pie',
    categoriesChart: 'bar',
    blocksChart: 'pie'
};

// Function to toggle chart type
function toggleChartType(chartId) {
    const currentType = chartTypes[chartId];
    const newType = currentType === 'pie' ? 'bar' : 'pie';
    chartTypes[chartId] = newType;
    
    // Re-render the chart with new type
    renderChart(chartId);
}

// Function to render charts
function renderChart(chartId) {
    const chartElement = document.getElementById(chartId);
    if (!chartElement) return;
    
    // Dispose of existing chart instance if it exists
    if (chartInstances[chartId]) {
        chartInstances[chartId].dispose();
    }
    
    // Initialize chart
    const chart = echarts.init(chartElement);
    chartInstances[chartId] = chart;
    
    // Set chart options based on chart ID
    let option;
    
    switch(chartId) {
        case 'sacksChart':
            option = getSacksChartOption();
            break;
        case 'categoriesChart':
            option = getCategoriesChartOption();
            break;
        case 'blocksChart':
            option = getBlocksChartOption();
            break;
    }
    
    // Apply options and render chart
    chart.setOption(option);
    
    // Add resize listener
    window.addEventListener('resize', function() {
        chart.resize();
    });
}

// Sacks Chart Options
function getSacksChartOption() {
    const chartType = chartTypes.sacksChart;
    
    return {
        tooltip: {
            trigger: 'item',
            formatter: '{a} <br/>{b}: {c} ({d}%)'
        },
        legend: {
            orient: 'horizontal',
            bottom: 0,
            data: ['Ghana', 'Ivory Coast', 'Nigeria', 'Cameroon']
        },
        series: [{
            name: 'Sacks',
            type: chartType,
            radius: chartType === 'pie' ? ['40%', '70%'] : null,
            avoidLabelOverlap: false,
            itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
            },
            label: {
                show: true,
                formatter: '{b}: {c}'
            },
            emphasis: {
                label: {
                    show: true,
                    fontSize: '14',
                    fontWeight: 'bold'
                }
            },
            labelLine: {
                show: true
            },
            data: [
                {value: {{ sack_totals.total_ghana }}, name: 'Ghana', itemStyle: {color: '#4e73df'}},
                {value: {{ sack_totals.total_ivc }}, name: 'Ivory Coast', itemStyle: {color: '#1cc88a'}},
                {value: {{ sack_totals.total_nigeria }}, name: 'Nigeria', itemStyle: {color: '#36b9cc'}},
                {value: {{ sack_totals.total_cameroon }}, name: 'Cameroon', itemStyle: {color: '#f6c23e'}}
            ],
            animationType: 'scale',
            animationEasing: 'elasticOut',
            animationDelay: function (idx) {
                return Math.random() * 200;
            }
        }]
    };
}

// Categories Chart Options
function getCategoriesChartOption() {
    const chartType = chartTypes.categoriesChart;
    
    // Prepare data
    const categories = [];
    const data = [];
    
    {% for item in category_stock %}
    categories.push('{{ item.bean_category|default:"Unknown"|escapejs }}');
    data.push({{ item.total_bags|default:0 }});
    {% endfor %}
    
    return {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '10%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: categories,
            axisLabel: {
                interval: 0,
                rotate: categories.length > 5 ? 45 : 0
            }
        },
        yAxis: {
            type: 'value',
            name: 'Bags'
        },
        series: [{
            name: 'Bags',
            type: chartType,
            data: data,
            itemStyle: {
                color: function(params) {
                    const colors = ['#e74a3b', '#6f42c1','#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', ];
                    return colors[params.dataIndex % colors.length];
                },
                borderRadius: chartType === 'bar' ? [5, 5, 0, 0] : 0
            },
            barWidth: '60%',
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            animationType: 'scale',
            animationEasing: 'elasticOut',
            animationDelay: function (idx) {
                return idx * 100;
            }
        }]
    };
}
// Blocks Chart Options - Stacked Bar Chart with percentage breakdown
function getBlocksChartOption() {
    // Prepare data
    const blocks = [];
    const blockData = [];
    
    {% for item in block_stock %}
    blocks.push('{{ item.block|escapejs }}');
    blockData.push({
        name: '{{ item.block|escapejs }}',
        value: {{ item.total_bags|default:0 }},
        tonnage: {{ item.total_tonnage|default:0|floatformat:2 }}
    });
    {% endfor %}
    
    // Sort data by value (descending)
    blockData.sort((a, b) => b.value - a.value);
    
    // Extract sorted values and names
    const values = blockData.map(item => item.value);
    const names = blockData.map(item => item.name);
    const tonnages = blockData.map(item => item.tonnage);
    
    // Calculate total for percentage
    const total = values.reduce((sum, value) => sum + value, 0);
    
    return {
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'shadow'
            },
            formatter: function(params) {
                const data = params[0];
                const percentage = total > 0 ? ((data.value / total) * 100).toFixed(1) : 0;
                const blockDataItem = blockData.find(item => item.name === data.name);
                return `
                    <div><strong>${data.name}</strong></div>
                    <div>Bags: ${data.value}</div>
                    <div>Tonnage: ${blockDataItem ? blockDataItem.tonnage : 0} MT</div>
                    <div>Percentage: ${percentage}%</div>
                `;
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '10%',
            containLabel: true
        },
        xAxis: {
            type: 'value',
            name: 'Number of Bags',
            axisLabel: {
                formatter: '{value}'
            }
        },
        yAxis: {
            type: 'category',
            data: names,
            axisLabel: {
                interval: 0,
                formatter: function(value) {
                    // Truncate long names and add ellipsis
                    return value.length > 12 ? value.substring(0, 12) + '...' : value;
                }
            }
        },
        series: [{
            name: 'Bags',
            type: 'bar',
            data: values.map((value, index) => {
                const colors = ['#2c9faf','#858796','#5a5c69','#2e59d9', '#17a673','#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', 
                                '#f8f9fa'];
                return {
                    value: value,
                    itemStyle: {
                        color: colors[index % colors.length],
                        borderRadius: [0, 4, 4, 0]
                    }
                };
            }),
            label: {
                show: true,
                position: 'right',
                formatter: function(params) {
                    const percentage = total > 0 ? ((params.value / total) * 100).toFixed(1) : 0;
                    return `${params.value} (${percentage}%)`;
                }
            },
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            animationType: 'scale',
            animationEasing: 'elasticOut',
            animationDelay: function (idx) {
                return idx * 100;
            }
        }],
        dataZoom: [{
            type: 'inside',
            yAxisIndex: 0,
            filterMode: 'empty'
        }]
    };
}

// Initialize all charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    renderChart('sacksChart');
    renderChart('categoriesChart');
    renderChart('blocksChart');
    
    // Counter animation
    const counters = document.querySelectorAll('.counter-value');
    const speed = 200;
    
    counters.forEach(counter => {
        const targetValue = parseInt(counter.getAttribute('data-target'));
        let currentValue = 0;
        const increment = Math.ceil(targetValue / speed);
        
        const updateCounter = () => {
            currentValue += increment;
            if (currentValue > targetValue) {
                counter.innerText = targetValue;
            } else {
                counter.innerText = currentValue;
                setTimeout(updateCounter, 1);
            }
        };
        
        updateCounter();
    });
    
    // // Add hover effects to cards
    // const cards = document.querySelectorAll('.card');
    // cards.forEach(card => {
    //     card.addEventListener('mouseenter', function() {
    //         this.style.transform = 'translateY(-5px)';
    //         this.style.boxShadow = '0 0.5rem 2rem 0 rgba(58, 59, 69, 0.2)';
    //     });
        
    //     card.addEventListener('mouseleave', function() {
    //         this.style.transform = '';
    //         this.style.boxShadow = '';
    //     });
    // });
});
</script>
{% endblock %}