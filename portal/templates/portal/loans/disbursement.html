{% extends 'web_base.html' %}
{% load i18n static %}
{% load custom_filters %}

{% block header %}
    {% include 'partials/header.html' %}
{% endblock %}

{% block greeting %}
<div class="row">
    <div class="col-12">
        <div class="page-title-box d-flex align-items-center justify-content-between">
            <div>
                <h4 class="fs-16 fw-semibold mb-1 mb-md-2">Loan Disbursements</h4>
                <p class="text-muted mb-0">View and manage loan disbursements</p>
            </div>
            <div class="page-title-right">
                <ol class="breadcrumb m-0">
                    <li class="breadcrumb-item"><a href="javascript: void(0);">Loan System</a></li>
                    <li class="breadcrumb-item active">Disbursements</li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock greeting %}

{% block main_content %}
<style>
    .btn-gradient-primary {
        background: linear-gradient(135deg, #0871B9 0%, #065a93 100%);
        color: white;
        border: none;
        text-transform: uppercase;
        transition: all 0.3s ease;
    }
    .btn-gradient-primary:hover {
        background: linear-gradient(135deg, #065a93 0%, #054a7a 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .disbursement-card {
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }
    .disbursement-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .status-badge {
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 600;
    }
    .detail-label {
        font-weight: 600;
        color: #0871B9;
    }
    .financial-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Loan Disbursements</h5>
                <div class="d-flex gap-2">
                    <select id="loanFilter" class="form-select form-select-sm" style="width: 200px;">
                        <option value="">All Loans</option>
                        <!-- Will be populated via AJAX -->
                    </select>
                    <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search..." style="width: 200px;">
                    <button class="btn btn-gradient-primary" id="refreshBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table id="disbursementTable" class="table table-striped table-bordered" style="width:100%">
                        <thead>
                            <tr>
                                <th>Disbursement ID</th>
                                <th>Loan ID</th>
                                <th>Farmer Name</th>
                                <th>National ID</th>
                                <th>Amount (GHS)</th>
                                <th>Disbursement Date</th>
                                <th>Stage</th>
                                <th>Transaction Reference</th>
                                <th>Disbursed By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disbursement Detail Modal -->
<div class="modal fade" id="disbursementDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white ">
                <h5 class="modal-title">Disbursement Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="disbursementDetailContent">
                    <!-- Content will be loaded via AJAX -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> © Loan Management System.
            </div>
        </div>
    </div>
</footer>

<!-- DataTables and other scripts -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var disbursementTable = $('#disbursementTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: "{% url 'disbursement_list' %}",
            type: "GET",
            data: function(d) {
                d.loan_id = $('#loanFilter').val();
                d.search = $('#searchInput').val();
            }
        },
        columns: [
            { "data": "id" },
            { 
                "data": "loan_id",
                "render": function(data, type, row) {
                    return `<a href="/loans/applications/detail/${row.loan_id}/" target="_blank">${data}</a>`;
                }
            },
            { "data": "farmer_name" },
            { "data": "farmer_national_id" },
            { 
                "data": "amount",
                "render": function(data, type, row) {
                    return '₵' + parseFloat(data).toLocaleString('en-US', {minimumFractionDigits: 2});
                }
            },
            { "data": "disbursement_date" },
            { "data": "stage" },
            { "data": "transaction_reference" },
            { "data": "disbursed_by" },
            {
                "data": "id",
                "render": function(data, type, row) {
                    return `
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info view-btn" data-id="${data}" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[5, 'desc']], // Sort by disbursement date descending
        dom: 'Bfrtip',
        buttons: [
            {
                extend: "copy",
                text: '<i class="fas fa-copy"></i> Copy',
                className: "btn btn-sm btn-outline-secondary",
            },
            {
                extend: "csv",
                text: '<i class="fas fa-file-csv"></i> CSV',
                className: "btn btn-sm btn-outline-success",
            },
            {
                extend: "excel",
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: "btn btn-sm btn-outline-primary",
            },
            {
                extend: "pdf",
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: "btn btn-sm btn-outline-danger",
            },
            {
                text: '<i class="fas fa-sync-alt"></i> Refresh',
                className: "btn btn-sm btn-outline-info",
                action: function (e, dt, node, config) {
                    dt.ajax.reload();
                }
            }
        ]
    });

    // Load loans for filter dropdown
    function loadLoansForFilter() {
        $.ajax({
            url: "{% url 'get_loans_with_disbursements' %}",
            type: "GET",
            success: function(response) {
                if (response.success) {
                    const loanFilter = $('#loanFilter');
                    loanFilter.empty().append('<option value="">All Loans</option>');
                    
                    response.loans.forEach(function(loan) {
                        loanFilter.append(
                            $('<option>', {
                                value: loan.id,
                                text: `${loan.loan_id} - ${loan.farmer_name}`
                            })
                        );
                    });
                }
            }
        });
    }

    // Filter handlers
    $('#loanFilter').change(function() {
        disbursementTable.ajax.reload();
    });

    $('#searchInput').on('keyup', function() {
        disbursementTable.ajax.reload();
    });

    $('#refreshBtn').click(function() {
        disbursementTable.ajax.reload();
    });

    // View disbursement details
    $('#disbursementTable').on('click', '.view-btn', function() {
        const disbursementId = $(this).data('id');
        
        $.ajax({
            url: `/loans/disbursements/detail/${disbursementId}/`,
            type: "GET",
            success: function(response) {
                if (response.success) {
                    $('#disbursementDetailContent').html(`
                        <div class="row">
                            <div class="col-md-6">
                                <div class="financial-card mb-3">
                                    <h5 class="mb-3">Disbursement Information</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p><span class="detail-label">Disbursement ID:</span> ${response.disbursement.id}</p>
                                            <p><span class="detail-label">Loan ID:</span> <a href="/loans/applications/detail/${response.disbursement.loan_id}/" target="_blank">${response.disbursement.loan_id}</a></p>
                                            <p><span class="detail-label">Amount:</span> ₵${parseFloat(response.disbursement.amount).toLocaleString('en-US', {minimumFractionDigits: 2})}</p>
                                            <p><span class="detail-label">Disbursement Date:</span> ${response.disbursement.disbursement_date}</p>
                                            <p><span class="detail-label">Stage:</span> ${response.disbursement.stage}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="financial-card mb-3">
                                    <h5 class="mb-3">Transaction Details</h5>
                                    <div class="row">
                                        <div class="col-12">
                                            <p><span class="detail-label">Transaction Reference:</span> ${response.disbursement.transaction_reference || 'Not provided'}</p>
                                            <p><span class="detail-label">Disbursed By:</span> ${response.disbursement.disbursed_by || 'Not specified'}</p>
                                            <p><span class="detail-label">Created:</span> ${response.disbursement.created_at}</p>
                                            <p><span class="detail-label">Last Updated:</span> ${response.disbursement.updated_at}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Farmer Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><span class="detail-label">Name:</span> ${response.disbursement.farmer_name}</p>
                                        <p><span class="detail-label">National ID:</span> ${response.disbursement.farmer_national_id}</p>
                                        <p><span class="detail-label">Project:</span> ${response.disbursement.project_name || 'N/A'} (${response.disbursement.project_code || 'N/A'})</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Notes</h6>
                                    </div>
                                    <div class="card-body">
                                        <p>${response.disbursement.notes || 'No notes provided for this disbursement.'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                    $('#disbursementDetailModal').modal('show');
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load disbursement details'
                });
            }
        });
    });

    // Initialize page
    loadLoansForFilter();
    disbursementTable.ajax.reload();
});
</script>
{% endblock %}