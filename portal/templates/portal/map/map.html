{% extends 'web_base.html' %}
{% load i18n static %}
{% load custom_filters %}
{% load monitoring_filters %}
{% load humanize %}

{% block header %}
    {% include 'partials/header.html' %}
{% endblock %}

{% block main_content %}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<!-- Full Screen Container -->
<div id="fullscreen-container">
    <div class="row fullscreen-content">
        <div class="col-12">
            <!-- Map Container -->
            <div class="search-top-container">
                <div class="search-top-card">
                    <!-- <div class="search-top-header">
                        <i class="fas fa-search me-2"></i>
                        <span>Search Farms</span>
                    </div> -->
                    <div class="search-top-body">
                        <div class="input-group input-group-sm">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search by farm code, name, or farmer...">
                            <button class="btn btn-outline-secondary" id="clearSearchBtn" type="button" title="Clear search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="searchResults" class="search-results mt-1" style="display: none;"></div>
                        
                        <div id="searchStats" class="search-stats mt-2" style="display: none;">
                            <small class="text-muted" id="matchesCount">0 matches</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fullscreen-card">
                <div class="card-body p-0 position-relative">
                    <div id="map" style="height: 90vh; width: 100%;"></div>
                    
                    <!-- Floating Controls Panel -->
                    <div class="map-controls-panel">
                        <div class="panel-header">
                            <h6>Map Controls</h6>
                            <button id="togglePanel" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                        
                        <div class="panel-content">
                            
                            <!-- Layers Section -->
                            <div class="control-section">
                               
                            </div>

                             <!-- Base Maps Section -->
                           <div class="control-section">
                                <div class="section-header" data-toggle="base-maps-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-map"></i>
                                    <span>Base Maps</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="base-maps-section">
                                    <div class="layer-control-group">
                                        <!-- Hybrid Layer Card -->
                                        <div class="layer-card">
                                            <input class="layer-radio" type="radio" name="baseMap" id="hybridLayer" checked>
                                            <label class="layer-card-content" for="hybridLayer">
                                                <div class="layer-preview">
                                                    <img src="/static/images/basemaps/open.png" alt="Hybrid Map" class="layer-image">
                                                    <div class="layer-overlay">
                                                        <i class="fas fa-check-circle selected-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="layer-info">
                                                    <i class="fas fa-map layer-icon"></i>
                                                    <span class="layer-name">Hybrid</span>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Streets Layer Card -->
                                        <div class="layer-card">
                                            <input class="layer-radio" type="radio" name="baseMap" id="streetLayer">
                                            <label class="layer-card-content" for="streetLayer">
                                                <div class="layer-preview">
                                                    <img src="/static/images/basemaps/street.png" alt="Street Map" class="layer-image">
                                                    <div class="layer-overlay">
                                                        <i class="fas fa-check-circle selected-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="layer-info">
                                                    <i class="fas fa-road layer-icon"></i>
                                                    <span class="layer-name">Streets</span>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Satellite Layer Card -->
                                        <div class="layer-card">
                                            <input class="layer-radio" type="radio" name="baseMap" id="satelliteLayer">
                                            <label class="layer-card-content" for="satelliteLayer">
                                                <div class="layer-preview">
                                                    <img src="/static/images/basemaps/satellite.png" alt="Satellite Map" class="layer-image">
                                                    <div class="layer-overlay">
                                                        <i class="fas fa-check-circle selected-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="layer-info">
                                                    <i class="fas fa-satellite layer-icon"></i>
                                                    <span class="layer-name">Satellite</span>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Terrain Layer Card -->
                                        <div class="layer-card">
                                            <input class="layer-radio" type="radio" name="baseMap" id="terrainLayer">
                                            <label class="layer-card-content" for="terrainLayer">
                                                <div class="layer-preview">
                                                    <img src="/static/images/basemaps/terrian.png" alt="Terrain Map" class="layer-image">
                                                    <div class="layer-overlay">
                                                        <i class="fas fa-check-circle selected-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="layer-info">
                                                    <i class="fas fa-mountain layer-icon"></i>
                                                    <span class="layer-name">Terrain</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Base Map Opacity -->
                                    <div class="opacity-control mt-4">
                                        <h6 class="opacity-title">
                                            <i class="fas fa-adjust me-2"></i>Base Map Opacity
                                        </h6>
                                        <div class="slider-container">
                                            <input type="range" class="form-range base-opacity-slider" id="baseOpacitySlider" min="0" max="100" value="100">
                                            <div class="slider-labels">
                                                <span>0%</span>
                                                <span id="baseOpacityValue">100%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <style>
                                /* Layer Cards Container */
                            .layer-control-group {
                                display: grid;
                                grid-template-columns: repeat(2, 1fr);
                                gap: 12px;
                                margin-bottom: 16px;
                            }

                            /* Layer Card Styles */
                            .layer-card {
                                position: relative;
                                border-radius: 12px;
                                overflow: hidden;
                                transition: all 0.3s ease;
                                border: 2px solid var(--bs-border-color);
                                background: var(--bs-card-bg);
                            }

                            .layer-card:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
                                border-color: var(--bs-primary);
                            }

                            .layer-radio {
                                display: none;
                            }

                            .layer-radio:checked + .layer-card-content {
                                border-color: var(--bs-primary);
                            }

                            .layer-radio:checked + .layer-card-content .layer-preview {
                                border-color: var(--bs-primary);
                            }

                            .layer-radio:checked + .layer-card-content .selected-icon {
                                opacity: 1;
                                transform: scale(1);
                            }

                            .layer-radio:checked + .layer-card-content .layer-image {
                                transform: scale(1.05);
                            }

                            .layer-card-content {
                                display: block;
                                cursor: pointer;
                                border-radius: 10px;
                                transition: all 0.3s ease;
                                border: 2px solid transparent;
                            }

                            /* Layer Preview with Images */
                            .layer-preview {
                                position: relative;
                                height: 90px;
                                border-radius: 8px 8px 0 0;
                                overflow: hidden;
                                border: 1px solid var(--bs-border-color);
                                transition: all 0.3s ease;
                            }

                            .layer-image {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                                transition: all 0.3s ease;
                            }

                            .layer-card:hover .layer-image {
                                transform: scale(1.05);
                            }

                            /* Layer Overlay */
                            .layer-overlay {
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: linear-gradient(135deg, 
                                    rgba(var(--bs-primary-rgb), 0.2) 0%, 
                                    rgba(var(--bs-primary-rgb), 0.1) 50%,
                                    transparent 100%);
                                display: flex;
                                align-items: flex-end;
                                justify-content: flex-end;
                                padding: 8px;
                                opacity: 0;
                                transition: all 0.3s ease;
                            }

                            .layer-card:hover .layer-overlay {
                                opacity: 1;
                            }

                            .selected-icon {
                                color: var(--bs-primary);
                                font-size: 20px;
                                opacity: 0;
                                transform: scale(0.8);
                                transition: all 0.3s ease;
                                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
                                background: rgba(255, 255, 255, 0.9);
                                border-radius: 50%;
                                padding: 2px;
                            }

                            /* Layer Info */
                            .layer-info {
                                padding: 12px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                background: var(--bs-card-bg);
                                border-top: 1px solid var(--bs-border-color);
                                transition: all 0.3s ease;
                            }

                            .layer-card:hover .layer-info {
                                background: var(--bs-secondary-bg);
                            }

                            .layer-icon {
                                color: var(--bs-primary);
                                font-size: 14px;
                                width: 16px;
                                text-align: center;
                            }

                            .layer-name {
                                font-weight: 600;
                                color: var(--bs-heading-color);
                                font-size: 14px;
                                transition: all 0.3s ease;
                            }

                            .layer-card:hover .layer-name {
                                color: var(--bs-primary);
                            }

                            /* Opacity Control */
                            .opacity-control {
                                background: var(--bs-secondary-bg);
                                padding: 16px;
                                border-radius: 8px;
                                border: 1px solid var(--bs-border-color);
                            }

                            .opacity-title {
                                color: var(--bs-heading-color);
                                font-size: 14px;
                                font-weight: 600;
                                margin-bottom: 12px;
                                display: flex;
                                align-items: center;
                            }

                            .slider-container {
                                position: relative;
                            }

                            .base-opacity-slider {
                                width: 100%;
                                height: 6px;
                                border-radius: 3px;
                                background: var(--bs-border-color);
                                outline: none;
                                -webkit-appearance: none;
                            }

                            .base-opacity-slider::-webkit-slider-thumb {
                                -webkit-appearance: none;
                                appearance: none;
                                width: 18px;
                                height: 18px;
                                border-radius: 50%;
                                background: var(--bs-primary);
                                cursor: pointer;
                                border: 2px solid var(--bs-card-bg);
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                                transition: all 0.3s ease;
                            }

                            .base-opacity-slider::-webkit-slider-thumb:hover {
                                transform: scale(1.2);
                                box-shadow: 0 4px 12px rgba(var(--bs-primary-rgb), 0.4);
                            }

                            .base-opacity-slider::-moz-range-thumb {
                                width: 18px;
                                height: 18px;
                                border-radius: 50%;
                                background: var(--bs-primary);
                                cursor: pointer;
                                border: 2px solid var(--bs-card-bg);
                                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                            }

                            .slider-labels {
                                display: flex;
                                justify-content: space-between;
                                margin-top: 8px;
                                font-size: 12px;
                                color: var(--bs-muted-color);
                            }

                            /* Active State for Selected Layer */
                            .layer-radio:checked + .layer-card-content .layer-overlay {
                                opacity: 1;
                                background: linear-gradient(135deg, 
                                    rgba(var(--bs-primary-rgb), 0.3) 0%, 
                                    rgba(var(--bs-primary-rgb), 0.2) 50%,
                                    transparent 100%);
                            }

                            .layer-radio:checked + .layer-card-content .layer-info {
                                background: rgba(var(--bs-primary-rgb), 0.05);
                                border-top-color: var(--bs-primary);
                            }

                            .layer-radio:checked + .layer-card-content .layer-name {
                                color: var(--bs-primary);
                                font-weight: 700;
                            }

                            /* Loading State for Images */
                            .layer-image {
                                background: linear-gradient(90deg, 
                                    var(--bs-border-color) 25%, 
                                    var(--bs-secondary-bg) 50%, 
                                    var(--bs-border-color) 75%);
                                background-size: 200% 100%;
                                animation: loading 1.5s infinite;
                            }

                            @keyframes loading {
                                0% {
                                    background-position: 200% 0;
                                }
                                100% {
                                    background-position: -200% 0;
                                }
                            }

                            .layer-image.loaded {
                                animation: none;
                                background: none;
                            }

                            /* Responsive Design */
                            @media (max-width: 768px) {
                                .layer-control-group {
                                    grid-template-columns: 1fr;
                                    gap: 10px;
                                }
                                
                                .layer-preview {
                                    height: 80px;
                                }
                                
                                .layer-info {
                                    padding: 10px;
                                }
                                
                                .opacity-control {
                                    padding: 12px;
                                }
                            }

                            /* Dark Mode Enhancements */
                            :root[data-bs-theme="dark"] .layer-image {
                                filter: brightness(0.9) contrast(1.1);
                            }

                            :root[data-bs-theme="dark"] .layer-card:hover .layer-image {
                                filter: brightness(1.1) contrast(1.05);
                            }

                            :root[data-bs-theme="dark"] .selected-icon {
                                background: rgba(0, 0, 0, 0.7);
                                color: var(--bs-primary);
                            }

                            /* Focus States for Accessibility */
                            .layer-card-content:focus {
                                outline: 2px solid var(--bs-primary);
                                outline-offset: 2px;
                            }

                            .base-opacity-slider:focus {
                                outline: 2px solid var(--bs-primary);
                                outline-offset: 2px;
                            }

                            /* Section Toggle Animation */
                            .section-content {
                                transition: all 0.3s ease;
                                overflow: hidden;
                            }

                            .section-content.collapsed {
                                display: none;
                            }

                            .toggle-icon {
                                transition: transform 0.3s ease;
                            }

                            .section-header.active .toggle-icon {
                                transform: rotate(180deg);
                            }
                            </style>

                            <script>
                            // Update opacity value display
                            document.getElementById('baseOpacitySlider').addEventListener('input', function(e) {
                                document.getElementById('baseOpacityValue').textContent = e.target.value + '%';
                            });

                            // Handle layer selection
                            document.querySelectorAll('.layer-radio').forEach(radio => {
                                radio.addEventListener('change', function(e) {
                                    // Update visual selection state
                                    document.querySelectorAll('.layer-card').forEach(card => {
                                        card.classList.remove('active');
                                    });
                                    e.target.closest('.layer-card').classList.add('active');
                                    
                                    // Here you would typically update the map base layer
                                    const layerType = e.target.id.replace('Layer', '').toLowerCase();
                                    console.log('Selected base layer:', layerType);
                                    
                                    // Dispatch custom event for map integration
                                    const event = new CustomEvent('basemapChange', {
                                        detail: { layer: layerType, opacity: document.getElementById('baseOpacitySlider').value }
                                    });
                                    document.dispatchEvent(event);
                                });
                            });

                            // Toggle section visibility
                            document.querySelector('.section-header').addEventListener('click', function() {
                                const content = document.getElementById('base-maps-section');
                                const icon = this.querySelector('.toggle-icon');
                                
                                content.classList.toggle('collapsed');
                                this.classList.toggle('active');
                            });

                            // Handle image loading
                            document.querySelectorAll('.layer-image').forEach(img => {
                                img.addEventListener('load', function() {
                                    this.classList.add('loaded');
                                });
                                
                                // Fallback for error handling
                                img.addEventListener('error', function() {
                                    console.warn('Failed to load layer image:', this.src);
                                    // You could set a fallback background color or pattern here
                                    this.style.background = 'var(--bs-secondary-bg)';
                                    this.style.display = 'flex';
                                    this.style.alignItems = 'center';
                                    this.style.justifyContent = 'center';
                                    this.innerHTML = '<i class="fas fa-map" style="font-size: 24px; color: var(--bs-muted-color);"></i>';
                                });
                            });

                            // Initialize first layer as active
                            document.querySelector('.layer-radio:checked').closest('.layer-card').classList.add('active');

                            // Handle opacity changes
                            document.getElementById('baseOpacitySlider').addEventListener('change', function(e) {
                                const event = new CustomEvent('opacityChange', {
                                    detail: { opacity: e.target.value }
                                });
                                document.dispatchEvent(event);
                            });
                            </script>

                            <!-- Farm Data Layers Section -->
                            <div class="control-section">
                                <div class="section-header" data-toggle="farm-data-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-tractor"></i>
                                    <span>Farm Data Layers</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="farm-data-section">
                                    <div class="layer-control-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="farmLayer" checked>
                                            <label class="form-check-label" for="farmLayer">
                                                <i class="fas fa-tractor me-1"></i>Farm Boundaries
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="treeDensityLayer">
                                            <label class="form-check-label" for="treeDensityLayer">
                                                <i class="fas fa-tree me-1"></i>Tree Density
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="cropHealthLayer">
                                            <label class="form-check-label" for="cropHealthLayer">
                                                <i class="fas fa-leaf me-1"></i>Crop Health (NDVI)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="irrigationLayer">
                                            <label class="form-check-label" for="irrigationLayer">
                                                <i class="fas fa-tint me-1"></i>Irrigation Coverage
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Farm Layers Opacity -->
                                    <div class="opacity-control mt-3">
                                        <h6 class="opacity-title">
                                            <i class="fas fa-adjust me-1"></i>Farm Layers Opacity
                                        </h6>
                                        <input type="range" class="form-range farm-opacity-slider" id="farmOpacitySlider" min="0" max="100" value="70">
                                        <small class="text-muted" id="farmOpacityValue">70%</small>
                                    </div>
                                </div>
                            </div>

                             <!-- Environmental Layers Section -->
                            <div class="control-section">
                                <div class="section-header" data-toggle="environmental-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-seedling"></i>
                                    <span>Environmental Layers</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="environmental-section">
                                    <div class="layer-control-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="soilTypeLayer">
                                            <label class="form-check-label" for="soilTypeLayer">
                                                <i class="fas fa-seedling me-1"></i>Soil Types
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="climateZoneLayer">
                                            <label class="form-check-label" for="climateZoneLayer">
                                                <i class="fas fa-cloud-sun me-1"></i>Climate Zones
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="roadsLayer">
                                            <label class="form-check-label" for="roadsLayer">
                                                <i class="fas fa-road me-1"></i>Road Network
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Environmental Layers Opacity -->
                                    <div class="opacity-control mt-3">
                                        <h6 class="opacity-title">
                                            <i class="fas fa-adjust me-1"></i>Environmental Layers Opacity
                                        </h6>
                                        <input type="range" class="form-range env-opacity-slider" id="envOpacitySlider" min="0" max="100" value="60">
                                        <small class="text-muted" id="envOpacityValue">60%</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Spatial Analysis Section -->
                            <div class="control-section">
                                <div class="section-header" data-toggle="analysis-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-chart-bar"></i>
                                    <span>Spatial Analysis</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="analysis-section">
                                    <div class="tools-group mb-3">
                                        <h6 class="tools-group-title">
                                            <i class="fas fa-buffer me-1"></i>Buffer Analysis
                                        </h6>
                                        <div class="input-group input-group-sm mb-2">
                                            <input type="number" id="bufferDistance" class="form-control" placeholder="Distance" value="1000" min="100" max="10000">
                                            <span class="input-group-text">meters</span>
                                        </div>
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="bufferIrrigationBtn" title="Buffer around irrigation sources">
                                                <i class="fas fa-tint"></i> Irrigation
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" id="bufferRoadsBtn" title="Buffer along roads">
                                                <i class="fas fa-road"></i> Roads
                                            </button>
                                        </div>
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button type="button" class="btn btn-outline-info btn-sm" id="bufferFarmsBtn" title="Buffer around farms">
                                                <i class="fas fa-tractor"></i> Farms
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" id="bufferGradientBtn" title="Multiple distance buffers">
                                                <i class="fas fa-layer-group"></i> Gradient
                                            </button>
                                        </div>
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-danger btn-sm" id="clearBufferBtn">
                                                <i class="fas fa-trash"></i> Clear All
                                            </button>
                                        </div>
                                        <div class="opacity-control mt-3">
                                            <h6 class="opacity-title">
                                                <i class="fas fa-adjust me-1"></i>Buffer Opacity
                                            </h6>
                                            <input type="range" class="form-range buffer-opacity-slider" id="bufferOpacitySlider" min="0" max="100" value="40">
                                            <small class="text-muted" id="bufferOpacityValue">40%</small>
                                        </div>
                                        </div>
                                    
                                    <div class="tools-group">
                                        <h6 class="tools-group-title">
                                            <i class="fas fa-info-circle me-1"></i>Active Buffers
                                        </h6>
                                        <div id="active-buffers-list" class="active-buffers-list">
                                            <small class="text-muted">No active buffers</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Opacity Section -->
                            <!-- <div class="control-section">
                                <div class="section-header" data-toggle="opacity-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-adjust"></i>
                                    <span>Polygon Opacity</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="opacity-section">
                                    <input type="range" class="form-range" id="opacitySlider" min="0" max="100" value="50">
                                    <small class="text-muted" id="opacityValue">50%</small>
                                </div>
                            </div> -->
                            
                            <!-- Legend Section -->
                            <!-- <div class="control-section">
                                <div class="section-header" data-toggle="legend-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-map"></i>
                                    <span>Polygon Legend</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="legend-section">
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #28a745;"></div>
                                        <small>Active</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #ffc107;"></div>
                                        <small>Delayed</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #dc3545;"></div>
                                        <small>Critical</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #17a2b8;"></div>
                                        <small>Completed</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center">
                                        <div class="legend-color" style="background-color: #6c757d;"></div>
                                        <small>Abandoned</small>
                                    </div>
                                </div>
                            </div> -->

                             <!-- Legend Section -->
                        <div class="control-section">
                            <div class="section-header" data-toggle="legend-section" style="display: flex;gap: 8px;">
                                <i class="fas fa-map"></i>
                                <span>Map Legend</span>
                                <i class="fas fa-chevron-down toggle-icon"></i>
                            </div>
                            <div class="section-content" id="legend-section">
                                <!-- Farm Status Legend -->
                                <div class="legend-group mb-3">
                                    <h6 class="legend-group-title">
                                        <i class="fas fa-tractor me-1"></i>Farm Status
                                    </h6>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #28a745;"></div>
                                        <small>Active</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #ffc107;"></div>
                                        <small>Delayed</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #dc3545;"></div>
                                        <small>Critical</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #17a2b8;"></div>
                                        <small>Completed</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center">
                                        <div class="legend-color" style="background-color: #6c757d;"></div>
                                        <small>Abandoned</small>
                                    </div>
                                </div>
                                
                                <!-- Tree Density Legend -->
                                <div class="legend-group mb-3">
                                    <h6 class="legend-group-title">
                                        <i class="fas fa-tree me-1"></i>Tree Density
                                    </h6>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #006400;"></div>
                                        <small>High (150+ trees/ha)</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #32CD32;"></div>
                                        <small>Medium (100-149 trees/ha)</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center">
                                        <div class="legend-color" style="background-color: #90EE90;"></div>
                                        <small>Low (&lt;100 trees/ha)</small>
                                    </div>
                                </div>
                                
                                <!-- Crop Health Legend -->
                                <div class="legend-group">
                                    <h6 class="legend-group-title">
                                        <i class="fas fa-leaf me-1"></i>Crop Health (NDVI)
                                    </h6>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #006400;"></div>
                                        <small>Excellent (0.7+)</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #32CD32;"></div>
                                        <small>Good (0.5-0.69)</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center mb-1">
                                        <div class="legend-color" style="background-color: #FFD700;"></div>
                                        <small>Fair (0.3-0.49)</small>
                                    </div>
                                    <div class="legend-item d-flex align-items-center">
                                        <div class="legend-color" style="background-color: #FF4500;"></div>
                                        <small>Poor (&lt;0.3)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                            
                            <!-- Tools Section -->
                            <div class="control-section">
                                <div class="section-header" data-toggle="tools-section" style="display: flex;gap: 8px;">
                                    <i class="fas fa-tools"></i>
                                    <span>Tools</span>
                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                </div>
                                <div class="section-content" id="tools-section">
                                    <!-- Measurement Tools -->
                                    <div class="tools-group mb-3">
                                        <h6 class="tools-group-title">
                                            <i class="fas fa-ruler-combined me-1"></i>Measurement Tools
                                        </h6>
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button type="button" class="btn btn-outline-success btn-sm" id="measureDistanceTool" title="Measure Distance">
                                                <i class="fas fa-ruler"></i> Distance
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" id="measureAreaTool" title="Measure Area">
                                                <i class="fas fa-draw-polygon"></i> Area
                                            </button>
                                        </div>
                                        <button type="button" class="btn btn-outline-danger btn-sm w-100" id="clearMeasureTool" title="Clear All Measurements">
                                            <i class="fas fa-trash"></i> Clear Measurements
                                        </button>
                                    </div>

                                    <!-- Map Tools -->
                                    <div class="tools-group mb-3">
                                        <h6 class="tools-group-title">
                                            <i class="fas fa-map me-1"></i>Map Tools
                                        </h6>
                                        <button id="refreshMap" class="btn btn-outline-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-sync-alt"></i> Refresh Map
                                        </button>
                                        <button id="fitToBounds" class="btn btn-outline-secondary btn-sm w-100 mb-1">
                                            <i class="fas fa-expand"></i> Fit to Farms
                                        </button>
                                        <button id="clearSelection" class="btn btn-outline-warning btn-sm w-100 mb-1">
                                            <i class="fas fa-times"></i> Clear Selection
                                        </button>
                                        <button id="fullScreenBtn" class="btn btn-outline-info btn-sm w-100">
                                            <i class="fas fa-expand-arrows-alt"></i> Full Screen
                                        </button>
                                    </div>

                                    <!-- Farm Tools -->
                                    <div class="tools-group">
                                        <h6 class="tools-group-title">
                                            <i class="fas fa-tractor me-1"></i>Farm Tools
                                        </h6>
                                        <button id="saveBoundaryBtn" class="btn btn-outline-success btn-sm w-100">
                                            <i class="fas fa-save"></i> Save Boundary
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farm Details Modal -->
            <div class="modal fade" id="farmModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Farm Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="farmDetails">
                            <!-- Farm details will be loaded here -->
                        </div>
                        <div class="modal-footer" style="display: flex;justify-content: center;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" id="editBoundaryBtn">
                                <i class="fas fa-edit"></i> Edit Boundary
                            </button>
                             <button type="button" class="btn btn-success" id="validateBoundaryBtn">
                                <i class="fas fa-check"></i> Validate Boundary
                            </button>
                            <button type="button" class="btn btn-success" id="saveBoundaryBtn" style="display: none;">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button type="button" class="btn btn-danger" id="cancelEditBtn" style="display: none;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}
<footer class="footer">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-sm-6">
                <script>document.write(new Date().getFullYear())</script> © EXIM M&E System.
            </div>
        </div>
    </div>
</footer>

<link rel="stylesheet" href="{% static 'css/map.css' %}">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<!-- Add this to your HTML head -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script src="{% static 'js/map.js' %}"></script>

{% endblock %}